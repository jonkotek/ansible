#
#
# Apache 2.4 - httpd.conf
#
#
#

ServerName ${WhichInstance}
ServerRoot "/opt/apps/apache64/${WhichVersion}"

PidFile ${PIDFILE}

DefaultRuntimeDir /work/nfs/apache/logs/${WhichInstance}/

Include /work/nfs/apache/conf/${InstanceGroup}/Listen_${WhichInstance}.conf

# Timeout value set here
Include /work/nfs/apache/conf/${InstanceGroup}/Timeout_${WhichInstance}.conf

# event MPM
# StartServers: initial number of server processes to start
# MinSpareThreads: minimum number of worker threads which are kept spare
# MaxSpareThreads: maximum number of worker threads which are kept spare
# ThreadsPerChild: constant number of worker threads in each server process
# MaxRequestWorkers: maximum number of worker threads
# MaxConnectionsPerChild: maximum number of connections a server process serves
#                         before terminating
<IfModule mpm_event_module>
    StartServers             3
    MinSpareThreads         75
    MaxSpareThreads        250
    ThreadsPerChild         50
    MaxRequestWorkers      1000
    ServerLimit            2000
    MaxConnectionsPerChild 50000
</IfModule>


#Loading requisite Apache Modules. Refer https://httpd.apache.org/docs/2.4/mod/ for further details

#Siteminder Mandatory Modules - For Apache 2.4 version
LoadModule sm_module "/opt/apps/siteminder64/webagent/bin/libmod_sm24.so"

#User authentication - Required for siteminder
LoadModule authn_dbd_module modules/mod_authn_dbd.so

#Manages a cache of authentication credentials to relieve the load on backends - Required for siteminder
LoadModule authn_socache_module modules/mod_authn_socache.so

#Siteminder Mandatory modules Ends

#Other Apache Modules

#Core Authentication
LoadModule authn_core_module modules/mod_authn_core.so

#User Authorization
LoadModule authz_user_module modules/mod_authz_user.so

#This module provides authorization capabilities
LoadModule authz_dbm_module modules/mod_authz_dbm.so

#Core Authorization.
LoadModule authz_core_module modules/mod_authz_core.so

#Easily restrict what HTTP methods can be used on the server
LoadModule allowmethods_module modules/mod_allowmethods.so

#shmcb based shared object cache provider.
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so

#Filters to handle and make available HTTP request bodies
LoadModule request_module modules/mod_request.so

#Server-parsed html documents (Server Side Includes)
LoadModule include_module modules/mod_include.so

#Associates the requested filename's extensions with the file's behavior
LoadModule mime_module modules/mod_mime.so

#Logging of the requests made to the server
LoadModule log_config_module modules/mod_log_config.so

#Logging of input and output bytes per request
LoadModule logio_module modules/mod_logio.so

#Generation of Expires and Cache-Control HTTP headers according to user-specified critea
LoadModule expires_module modules/mod_expires.so

#Generation of Expires and Cache-Control HTTP headers according to user-specified critea
LoadModule headers_module modules/mod_headers.so

#Allows the setting of environment variables based on characteristics of the request
LoadModule setenvif_module modules/mod_setenvif.so

#Multi-protocol proxy/gateway server
LoadModule proxy_module modules/mod_proxy.so

#HTTP support module for mod_proxy
LoadModule proxy_http_module modules/mod_proxy_http.so

#Session support
LoadModule session_module modules/mod_session.so

#Cookie based session support
LoadModule session_cookie_module modules/mod_session_cookie.so

#Strong cryptography using the SSl & TLS
LoadModule ssl_module modules/mod_ssl.so

#Basic (required) security for Unix-family platforms.
LoadModule unixd_module modules/mod_unixd.so

#Execute CGI scripts based on media type or request method.
LoadModule actions_module modules/mod_actions.so

#User-specific directories
LoadModule userdir_module modules/mod_userdir.so

#Provides for mapping different parts of the host filesystem in the document tree and for URL redirection
LoadModule alias_module modules/mod_alias.so

#Provides a rule-based rewriting engine to rewrite requested URLs on the fly
LoadModule rewrite_module modules/mod_rewrite.so

ServerAdmin Ts.MiddlewareServices@supervalu.com

SmInitFile "/work/nfs/apache/conf/${InstanceGroup}/${WhichInstance}/WebAgent_${WhichInstance}_conf"

<Directory />
   AllowOverride none
   AllowOverrideList ErrorDocument
   ErrorDocument 403 "Didn't find the page you are looking for?"
   ErrorDocument 404 "File Not Found"
    Require all denied
</Directory>

#<IfModule unixd_module>
User ${WhichUser}
Group nobody
#</IfModule>

#<IfModule dir_module>
#    DirectoryIndex index.html
#</IfModule>

<Files ".ht*">
    Require all denied
</Files>

<IfModule ssl_module>
SSLRandomSeed startup builtin
SSLRandomSeed connect builtin
</IfModule>

Alias /siteminderagent/pwcgi/ "/opt/apps/siteminder64/webagent/pw/"
<Directory "/opt/apps/siteminder64/webagent/pw/">
  Options MultiViews ExecCGI
       <Limit GET POST OPTIONS>
             Require all granted
       </Limit>
       <LimitExcept GET POST OPTIONS>
             Require all denied
       </LimitExcept>
   AllowOverride none
   AllowOverrideList ErrorDocument
   ErrorDocument 403 "Didn't find the page you are looking for?"
   ErrorDocument 404 "File Not Found"
   Require all granted
</Directory>
Alias /siteminderagent/pw/ "/opt/apps/siteminder64/webagent/pw/"
<Directory "/opt/apps/siteminder64/webagent/pw/">
  Options MultiViews ExecCGI
       <Limit GET POST OPTIONS>
             Require all granted
       </Limit>
       <LimitExcept GET POST OPTIONS>
             Require all denied
       </LimitExcept>
   AllowOverride none
   AllowOverrideList ErrorDocument
   ErrorDocument 403 "Didn't find the page you are looking for?"
   ErrorDocument 404 "File Not Found"
   Require all granted
</Directory>
Alias /siteminderagent/ "/opt/apps/siteminder64/webagent/samples/"
<Directory "/opt/apps/siteminder64/webagent/samples/">
  Options MultiViews
       <Limit GET POST OPTIONS>
             Require all granted
       </Limit>
       <LimitExcept GET POST OPTIONS>
             Require all denied
       </LimitExcept>
   Require all granted
   AllowOverride none
   AllowOverrideList ErrorDocument
   ErrorDocument 403 "Didn't find the page you are looking for?"
   ErrorDocument 404 "File Not Found"
</Directory>

<IfModule mime_module>
    TypesConfig /work/nfs/apache/common/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
# Siteminder
    AddHandler cgi-script .exe
#   AddHandler smformsauth-handler .fcc
</IfModule>

LogLevel warn
ErrorLog ${LOGDIR}/error_${WhichInstance}_${PROXYHOST}_${Ext_or_Int}.log

<IfModule log_config_module>
    #LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %T" combined
    #LogFormat "%h %l %u %t \"%r\" %>s %b" common
    LogFormat '%{Host}i | %h  | %{usernameSelectorCookie}C | %u | %t | %r | %s | %b | %{Referer}i | %{User-Agent}i | %T' combined
    LogFormat "%h %l %u %t \"%r\" %>s %b" common
    LogFormat '%h | %{usernameSelectorCookie}C | %{SSL_PROTOCOL}x | %{SSL_CIPHER}x | %u | %t | %r | %s | %b | %{Referer}i | %{User-Agent}i | %T' combinedssl
    LogFormat '%h | %{SSL_CLIENT_S_DN_CN}x | %{SSL_PROTOCOL}x | %{SSL_CIPHER}x | %u | %t | %r | %s | %b | %{Referer}i | %{User-Agent}i | %T' clientcertssl

    <IfModule logio_module>
      # You need to enable mod_logio.c to use %I and %O
      LogFormat "%{Host}i %a %B %D %b %h %l %m %p %P \"%q\" %u %U %X %t * \"%r\" %>s \"%{Referer}i\" \"%{User-Agent}i\" %I %O %T %{uid}i: %{cookie}n" combinedio
    </IfModule>
</IfModule>

# SSL configuration section
SSLCryptoDevice dynamic
AddType application/x-x509-ca-cert .crt
AddType application/x-pkcs7-crl    .crl
SSLPassPhraseDialog  builtin
SSLSessionCache        "shmcb:/work/ssl_oam/${WhichInstance}_ssl_scache(512000)"
SSLSessionCacheTimeout  300
SSLCipherSuite HIGH:MEDIUM:!aNULL:!ADH:!DH:!EDH:!KRB5:!IDEA:!EXP:!eNULL:!LOW:!RC4+RSA:!RC4:+HIGH:+MEDIUM
SSLProtocol All -SSLv2 -SSLv3 -TLSv1 -TLSv1.1 +TLSv1.2
SSLHonorCipherOrder On
# SSL Configuration Ends

Include /work/nfs/apache/conf/${InstanceGroup}/Hosts_${WhichInstance}.conf


